$(document).ready(function() {
    var $carousel = $('#moduleCarousel');
    var $nextControl = $('.carousel-control-next');
    var courseId = ...; // The ID of the current course

    // Initially disable the 'Next' button
    $nextControl.prop('disabled', true);

    // Event handler for checkbox change
    $('.module-complete-checkbox').change(function() {
        var isChecked = $(this).is(':checked');
        // Enable the 'Next' button if the checkbox is checked
        $nextControl.prop('disabled', !isChecked);
    });

    // Event handler for 'Next' button click
    $nextControl.click(function(e) {
        var $activeItem = $('.carousel-item.active');
        var $checkbox = $activeItem.find('.module-complete-checkbox');
        var moduleId = $activeItem.data('module-id');
        var isCompleted = $checkbox.is(':checked');
        var isPreviouslyCompleted = $checkbox.is(':disabled');

        if (isCompleted && !isPreviouslyCompleted) {
            // Save the module completion only if it's newly completed
            saveModuleCompletion(courseId, moduleId, $checkbox, $nextControl);
        } else if (!isCompleted) {
            e.preventDefault(); // Prevent moving to the next module if it's not completed
            alert('Please complete the current module before proceeding.');
        }
        // If the module was already completed (checkbox disabled), allow the carousel to move to the next slide
    });

    function saveModuleCompletion(courseId, moduleId, $checkbox, $nextControl) {
        // Perform AJAX call to save the completion
        $.ajax({
            url: '@Url.Action("MarkModuleComplete", "Courses")',
            type: 'POST',
            data: { courseId: courseId, moduleId: moduleId },
            beforeSend: function() {
                // Optionally, disable the checkbox while the request is processed
                $checkbox.prop('disabled', true);
            },
            success: function(response) {
                if(response.success) {
                    // Move to the next slide upon successful save
                    $carousel.carousel('next');
                } else {
                    // If save failed, re-enable the checkbox for user to try again
                    $checkbox.prop('disabled', false).prop('checked', false);
                    $nextControl.prop('disabled', true);
                    alert('Error saving module completion. Please try again.');
                }
            },
            error: function() {
                // Handle AJAX error
                $checkbox.prop('disabled', false).prop('checked', false);
                $nextControl.prop('disabled', true);
                alert('Error saving module completion.');
            }
        });
    }
});
