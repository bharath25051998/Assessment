steps:
- task: AzureCLI@2
  inputs:
    azureSubscription: 'YourServiceConnection'  # The ADO Service Connection with access to your subscription
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Variables
      sqlResourceGroupName="SqlServerResourceGroup"  # The resource group of your Azure SQL Server
      vnetResourceGroupName="VnetResourceGroup"      # The resource group of your VNet
      privateEndpointName="YourPrivateEndpointName"
      sqlServerName="YourSqlServerName"
      vnetName="YourVirtualNetworkName"
      subnetName="YourSubnetName"
      location="YourRegion"  # Example: eastus
      subscriptionId="YourSubscriptionId"  # Your Azure Subscription ID

      # Construct the full subnet ID (for a subnet in a different resource group)
      subnetId="/subscriptions/$subscriptionId/resourceGroups/$vnetResourceGroupName/providers/Microsoft.Network/virtualNetworks/$vnetName/subnets/$subnetName"

      # Create the private endpoint with the full subnet ID
      az network private-endpoint create \
        --name $privateEndpointName \
        --resource-group $sqlResourceGroupName \
        --subnet $subnetId \
        --private-connection-resource-id "/subscriptions/$subscriptionId/resourceGroups/$sqlResourceGroupName/providers/Microsoft.Sql/servers/$sqlServerName" \
        --group-id sqlServer \
        --connection-name "sqlserver-private-endpoint" \
        --location $location \
        --subscription $subscriptionId

      # Approve the private endpoint connection
      az sql server private-endpoint-connection approve \
        --name $privateEndpointName \
        --resource-group $sqlResourceGroupName \
        --server $sqlServerName \
        --description "Auto-approval via ADO pipeline" \
        --subscription $subscriptionId
