WITH MonthYear AS (
    SELECT DISTINCT CONCAT(DATENAME(MONTH, fromdate), '-', DATEPART(YEAR, fromdate)) AS Month_Year
    FROM #temp1
),
EmployeeUtilization AS (
    SELECT 
        MY.Month_Year,
        COALESCE(eu.EmployeeEmail, '') AS EmployeeEmail,
        COALESCE(SUM(eu.Allocation), 0) AS Total_Allocation
    FROM MonthYear MY
    LEFT JOIN #temp1 eu ON MY.Month_Year = CONCAT(DATENAME(MONTH, eu.fromdate), '-', DATEPART(YEAR, eu.fromdate))
    GROUP BY MY.Month_Year, eu.EmployeeEmail
),
ActiveEmployees AS (
    SELECT DISTINCT 
        MY.Month_Year,
        COALESCE(eu.EmployeeEmail, '') AS EmployeeEmail
    FROM MonthYear MY
    LEFT JOIN #temp1 eu ON MY.Month_Year = CONCAT(DATENAME(MONTH, eu.fromdate), '-', DATEPART(YEAR, eu.fromdate))
),
BenchCount AS (
    SELECT 
        MY.Month_Year,
        COUNT(*) AS Bench_Count
    FROM ActiveEmployees ae
    LEFT JOIN PSEmployeeAdditionalDetails ad ON ae.EmployeeEmail = ad.EmployeeEmail 
                                              AND MONTH(ad.ERD) = DATEPART(MONTH, CAST(CONCAT('01-', ae.Month_Year) AS DATE))
                                              AND YEAR(ad.ERD) = DATEPART(YEAR, CAST(CONCAT('01-', ae.Month_Year) AS DATE))
                                              AND ad.ERD IS NOT NULL
    WHERE ad.EmployeeEmail IS NULL
    GROUP BY MY.Month_Year
),
PartialBenchCount AS (
    SELECT 
        MY.Month_Year,
        COUNT(*) AS Partial_Bench_Count
    FROM EmployeeUtilization eu
    WHERE eu.Total_Allocation < 1
    GROUP BY MY.Month_Year
)
SELECT 
    MY.Month_Year, 
    COALESCE(bc.Bench_Count, 0) AS Bench_Count,
    COALESCE(pbc.Partial_Bench_Count, 0) AS Partial_Bench_Count
FROM MonthYear MY
LEFT JOIN BenchCount bc ON MY.Month_Year = bc.Month_Year
LEFT JOIN PartialBenchCount pbc ON MY.Month_Year = pbc.Month_Year;
