SELECT 
    l.lobname,
    COALESCE(SUM(CASE 
                    WHEN (MONTH(r.from_date) = MONTH(CURRENT_DATE()) AND YEAR(r.from_date) = YEAR(CURRENT_DATE())) OR
                         (MONTH(r.to_date) = MONTH(CURRENT_DATE()) AND YEAR(r.to_date) = YEAR(CURRENT_DATE()))
                    THEN r.billability 
                    ELSE 0 
                END), 0) AS total_billability,
    COALESCE(SUM(CASE 
                    WHEN b.band = 'b1' AND (MONTH(r.from_date) = MONTH(CURRENT_DATE()) AND YEAR(r.from_date) = YEAR(CURRENT_DATE())) OR
                         (MONTH(r.to_date) = MONTH(CURRENT_DATE()) AND YEAR(r.to_date) = YEAR(CURRENT_DATE()))
                    THEN r.billability 
                    ELSE 0 
                END), 0) AS total_b1_billability
FROM 
    lob_table l
LEFT JOIN 
    allocation_details a ON l.lobid = a.lobid
LEFT JOIN 
    records r ON a.allocationid = r.allocationid
LEFT JOIN 
    employee_table e ON a.employee_id = e.employee_id
LEFT JOIN 
    band_table b ON e.employee_id = b.employee_id
WHERE 
    r.from_date <= CURRENT_DATE() AND r.to_date <= CURRENT_DATE()
GROUP BY 
    l.lobname;
