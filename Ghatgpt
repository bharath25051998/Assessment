CREATE PROCEDURE [dbo].[PS_sp_GetLobspocchangeinfo]
    @EmployeeEmail NVARCHAR(500),
    @ChapterID INT,
    @LOB INT
AS
BEGIN
    ;WITH TempCTE AS (
        SELECT 
            LOB, 
            EmployeeEmail, 
            SPOC 
        FROM 
            PSEmployeeUtilizationDetails pd
        INNER JOIN 
            PSEmployeeUtilizationRecord pr ON pd.id = pr.AllocationId
        WHERE 
            FromDate <= GETDATE() 
            AND ToDate >= GETDATE() 
            AND pd.EmployeeEmail = @EmployeeEmail
    )
    SELECT 
        tb.*, 
        ps.UserName, 
        CASE 
            WHEN cl.ChapterLeadName IS NULL THEN cl.ChapterManagerName 
            WHEN cl.ChapterManagerName IS NULL THEN cl.ChapterLeadName 
            WHEN cl.ChapterLeadName IS NULL AND cl.ChapterManagerName IS NULL THEN '' 
            ELSE CONCAT(cl.ChapterLeadName, ';', cl.ChapterManagerName) 
        END AS ChapterManagers 
    FROM 
        TempCTE tb
    INNER JOIN 
        PSUserLogin ps ON ps.UserAdID = tb.EmployeeEmail
    LEFT OUTER JOIN 
        [chapterLeads] cl ON cl.id = @ChapterID
    WHERE 
        NOT EXISTS (SELECT 1 FROM TempCTE WHERE LOB = @LOB);
END;
